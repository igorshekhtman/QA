<html>

<style>
.bullet {
	font: 10px sans-serif;
}

.bullet .marker {
	stroke: #000;
	stroke-width: 2px;
}

.bullet .tick line {
	stroke: #666;
	stroke-width: .5px;
}

.bullet .range.s0 {
	fill: #ddd;
}

.bullet .range.s1 {
    fill: #E9D98F;
}

.bullet .measure.s0 {
	fill: green;
}

.bullet .measure.s1 {
	fill: steelblue;
}

.bullet .measure.s2 {
	fill: orange;
}

.bullet .measure.s3 {
	fill: lightsteelblue;
}

.bullet .title {
	font-size: 14px;
	font-weight: bold;
}

.bullet .subtitle {
	fill: #999;
}

.alternate.s0 {
    border-color: #003478;
    border: 1;
}
.alternate.s1 {
    border-color: #58A618;
    border: 1;
}
</style>

<head>
<title>Apixio Hive Dashboard</title>
<script src="//code.jquery.com/jquery-1.9.1.js"></script>
<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="mustache.js"></script>
<script src="d3.v3.min.js"></script>
<script src="bullet.js"></script>
<link rel="stylesheet" href="cat.css" type="text/css" />

<script>
        //------------Fetching data script---------------
            var url = "/hive/json/production/ui/group/completeness";
            
          //------------Bullet chart script-----------------------
            var margin = {top: 5, right: 40, bottom: 20, left: 120},
            width = 960 - margin.left - margin.right,
            height = 50 - margin.top - margin.bottom;

            var chart = d3.bullet()
                .width(width)
                .height(height);
           
             $.get(url).done(function( values ) {
            	 
            	 var orgHtml = "<ul>";
            	 $.each(values.orgs, function(n, data) {
            		 
            		 orgHtml = orgHtml + "<li>";
            		 
            		 var org_details = "\
                         <table border='1' class='success'> \
                         <tr><th>Org Name (Org Id)</th><th>Successful archives</th><th>Successful Uploads to Pipeline</th><th>Sent To OCR</th><th>Sent To Persist</th><th>OCRed</th><th>Persisted</th><th>Verified Persistence</th><th>Pending Parser documents</th><th>Pending Persist documents</th><th>Pending OCR documents</th></tr>\
                         <tr>\
                         <td>{{org_name}} ({{org_id}})</td>\
                         <td align='center'>{{archivedToS3_count}}</td>\
                         <td align='center'>{{upload_count}}</td>\
                         <td align='center'>{{sent_to_ocr}}</td>\
                         <td align='center'>{{sent_to_persist}}</td>\
                         <td align='center'>{{ocr_success_count}}</td>\
                         <td align='center'>{{persist_success_count}}</td>\
                         <td align='center'>{{verified_count}}</td>\
                         <td align='center' class='notice'>{{pending_parsers}}</td>\
                         <td align='center' class='notice'>{{pending_ocrs}}</td>\
                         <td align='center' class='notice'>{{pending_persists}}</td>\
                         </tr>\
                         </table>\
                         ";
     
                         orgHtml = orgHtml + Mustache.render(org_details, data);
                         
                         var chartId = 'chart'+n;
                         orgHtml = orgHtml + "<div id='"+chartId+"'></div><br/>";
                         
                         var errorObj = new Object();
                         
                         errorObj.org_name = data.org_name;
                         errorObj.org_id = data.org_id;
                         errorObj.upload_errors = processErrors(data.upload_errors);
                         errorObj.archive_errors = processErrors(data.archive_errors);
                         errorObj.parser_errors = processErrors(data.parse_errors);
                         errorObj.persist_errors = processErrors(data.persist_errors);
                         errorObj.ocr_errors = processErrors(data.ocr_errors);
                         errorObj.failed_parsers = data.failed_parsers;
                         errorObj.failed_ocrs = data.failed_ocrs;
                         errorObj.failed_persists = data.failed_persists;
                         
                         var errorDiv = "<table class='error'>\
                                         <tr><th>Org Name (Org Id)</th><th>Archive Error Documents</th><th>Upload Error Documents</th><th>Parser Error Documents</th><th>OCR Error Documents</th><th>Persist Error Documents</th><th>Failed Parser Documents</th><th>Failed OCR Documents</th><th>Failed Persist Documents</th></tr>\
                                         <tr><td>{{org_name}} ({{org_id}})</td><td>Total:<b>{{archive_errors.total}}</b><br/>{{#archive_errors.errorGroup}}<i>{{error_msg}}:</i> <b>{{count}}</b><br/>{{/archive_errors.errorGroup}}</td>\
                                         <td>Total:<b>{{upload_errors.total}}</b><br/><b>Details:</b><br/>{{#upload_errors.errorGroup}}<i>{{error_msg}}:</i> <b>{{count}}</b><br/>{{/upload_errors.errorGroup}}</td>\
                                         <td>Total:<b>{{parser_errors.total}}</b><br/><b>Details:</b><br/>{{#parser_errors.errorGroup}}<i>{{error_msg}}:</i> <b>{{count}}</b><br/>{{/parser_errors.errorGroup}}</td>\
                                         <td>Total:<b>{{ocr_errors.total}}</b><br/><b>Details:</b><br/>{{#ocr_errors.errorGroup}}<i>{{error_msg}}:</i> <b>{{count}}</b><br/>{{/ocr_errors.errorGroup}}</td>\
                                         <td>Total:<b>{{persist_errors.total}}</b><br/><b>Details:</b><br/>{{#persist_errors.errorGroup}}<i>{{error_msg}}:</i> <b>{{count}}</b><br/>{{/persist_errors.errorGroup}}</td>\
                                         <td class='notice'>{{failed_parsers}}</td><td class='notice'>{{failed_ocrs}}</td><td class='notice'>{{failed_persists}}</td></tr>\
                                         </table>";
                                         
                         orgHtml = orgHtml + Mustache.render(errorDiv, errorObj);
                         
                         var missingDocsData = calculateMissingDocuments(data, errorObj);
                         missingDocsData.org_name = data.org_name;
                         missingDocsData.org_id = data.org_id;
                         missingDocsData.abandoned_docs = data.abandoned_docs;
                         
                         var missingDocsDiv = "<table class='fatal'>\
                        	                   <tr><th>Org Name (Org Id)</th><th>Documents abandoned</th><th>Documents Not submitted to Coordinator yet</th><th>Documents seen by parser but missed by OCR job</th><th>Documents seen by parser but missed by Persist job</th><th>Total documents to be recovered</th></tr>\
                        	                   <tr><td>{{org_name}} ({{org_id}})</td><td>{{abandoned_docs}}</td><td>{{missingParser}}</td><td>{{missingOCR}}</td><td>{{missingPersist}}</td><td class='notice'><b>{{totalDocs}}</b></td></tr>\
                        	                   ";
                         
                         orgHtml = orgHtml + Mustache.render(missingDocsDiv, missingDocsData);
                         
                         orgHtml = orgHtml + "</li>";
                         
            		}); 
            	 
            	 orgHtml = orgHtml + "</ul>";
            	 
            	 $("#orgDetails").html(orgHtml);
            	 
            	 $.each(values.orgs, function(n, data) {
            		 
            		 var constructedJson = constructChartJson(data);
            		 var chartId = 'chart'+n;
            		 
                     var svg = d3.select("#"+chartId).selectAll("svg")
                    .data(constructedJson)
                  .enter().append("svg")
                    .attr("class", "bullet")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                    .call(chart);
      
	               var title = svg.append("g")
	                   .style("text-anchor", "end")
	                   .attr("transform", "translate(-6," + height / 2 + ")");
	     
	               title.append("text")
	                   .attr("class", "title")
	                   .text(function(d) { return d.title; });
	     
	               title.append("text")
	                   .attr("class", "subtitle")
	                   .attr("dy", "1em")
	                   .text(function(d) { return d.subtitle; }); 
            	 });
              }); 
             
           function constructChartJson(data) {
        	   var jsonStr = "";
        	   var sentToOcr = data.sent_to_ocr;
        	   var sentToPersist = data.sent_to_persist;
        	   var persisted = data.persist_success_count;
        	   var persistVerified = data.verified_count;
        	   var ocr = data.ocr_success_count;
        	   var uploadRange = data.upload_count;
        	   var ocrRange = data.sent_to_ocr;
        	   
        	   if (sentToOcr == undefined)
        		   sentToOcr = 0;
        	   if (sentToPersist == undefined)
        		   sentToPersist = 0;
        	   if (persisted == undefined)
        		   persisted = 0;
        	   if (persistVerified == undefined)
        		   persistVerified = 0;
        	   if (ocr == undefined)
        		   ocr = 0;
        	   if (uploadRange == undefined)
        		   uploadRange = 0;
        	   if (ocrRange == undefined)
        		   ocrRange = 0;
        	   
        	   jsonStr = [{"title":data.org_name,"subtitle":data.org_id,"measures":[persistVerified,persisted,ocr,sentToOcr+sentToPersist],"ranges":[uploadRange,sentToOcr],"markers":[uploadRange]}];
        	   
        	   return jsonStr;
           }  
           
           function processErrors(errors) {
        	   if (errors != undefined) {
        		   var errorDetails = new Object();
        		   var errorArr = new Array();
        		   var i = 0;
        		   var total = 0;
        		   $.each(errors, function(key, value){
                       errorArr[i] = {"error_msg":key,"count":value};
                       total = total + value;
                       i ++;
                    });
        		   
        		   errorDetails.errorGroup = errorArr;
        		   errorDetails.total = total;
        		   
        		   return errorDetails;
        	   }
        	   else {
        		   return {};
        	   }
           }
           
           function calculateMissingDocuments(data, errorDetails) {
        	   var missingDocs = new Object();
        	   var sentToOcr = data.sent_to_ocr;
               var sentToPersist = data.sent_to_persist;
               var persisted = data.persist_success_count;
               var ocr = data.ocr_success_count;
               var uploaded = data.upload_count;
               var pendingParsers = data.pending_parsers;
               var pendingPersists = data.pending_persists;
               var pendingOcrs = data.pending_ocrs;
               var errorParsers = errorDetails.parser_errors.total;
               var errorPersists = errorDetails.persist_errors.total;
               var errorOcrs = errorDetails.ocr_errors.total;
               var failedParsers = data.failed_parsers;
               var failedPersists = data.failed_persists;
               var failedOcrs = data.failed_ocrs;
               
               if (sentToOcr == undefined)
                   sentToOcr = 0;
               if (sentToPersist == undefined)
                   sentToPersist = 0;
               if (persisted == undefined)
                   persisted = 0;
               if (ocr == undefined)
                   ocr = 0;
               if (uploaded == undefined)
            	   uploaded = 0;
               if (pendingParsers == undefined)
            	   pendingParsers = 0;
               if (pendingPersists == undefined)
            	   pendingPersists = 0;
               if (pendingOcrs == undefined)
            	   pendingOcrs = 0;
               if (failedParsers == undefined)
            	   failedParsers = 0;
               if (failedOcrs == undefined)
            	   failedOcrs = 0;
               if (failedPersists == undefined)
            	   failedPersists = 0;
               if (errorParsers == undefined)
            	   errorParsers = 0;
               if (errorOcrs == undefined)
            	   errorOcrs = 0;
               if (errorPersists == undefined)
            	   errorPersists = 0;
        	   
        	   missingDocs.missingParser = uploaded - (sentToOcr + sentToPersist + pendingParsers + failedParsers + errorParsers);
        	   missingDocs.missingOCR = sentToOcr - (ocr + pendingOcrs + failedOcrs + errorOcrs);
        	   missingDocs.missingPersist = (sentToPersist + ocr) - (persisted + failedPersists + errorPersists + pendingPersists);
        	   
        	   missingDocs.totalDocs = missingDocs.missingParser + missingDocs.missingOCR + missingDocs.missingPersist;
        	   return missingDocs;
           }
          
        </script>
</head>

<body>
	<h1>Pipeline Upload Summary</h1>
	<div id="orgDetails"></div>
</body>
</html>