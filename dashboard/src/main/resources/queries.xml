<queries>

	<query name="archivedToS3_count">
		<text>
			select org_id, count(distinct(doc_id)) as doc_count, status, error_message
			from summary_docreceiver_archive  
			group by org_id, status, error_message
		</text>
	</query>
	<query name="upload_count">
        <text>
            select org_id, count(distinct(doc_id)) as doc_count, status, if(error_message like '/mnt%','No space left on device',error_message)
            from summary_docreceiver_upload   
            group by org_id, status, if(error_message like '/mnt%','No space left on device',error_message)
        </text>
    </query>
	<query name="parse_count">
		<text>
			select a.org_id, a.status, a.error_message, count(distinct a.doc_id) as doc_count, a.sent_to_ocr, a.sent_to_persist
            from summary_parser a
            join summary_coordinator_jobfinish b
            on a.hadoopjob_id = b.hadoop_job_id
            where b.status = "success"
            group by a.org_id, a.status, a.error_message, a.sent_to_ocr, a.sent_to_persist
		</text>
	</query>
	<query name="ocr_count">
        <text>
            select a.org_id, a.status, a.error_message, count(distinct a.doc_id) as doc_count 
            from summary_ocr a
            join summary_coordinator_jobfinish b
            on a.hadoopjob_id = b.hadoop_job_id
            where b.status = "success"
            group by a.org_id, a.status, a.error_message
        </text>
    </query>
    <query name="persist_count">
        <text>
            select a.org_id, a.status, a.error_message, count(distinct a.doc_id) as doc_count
            from summary_persist_mapper a 
            join summary_coordinator_jobfinish b 
            on a.hadoopjob_id = b.hadoop_job_id 
            where b.status = "success"
            group by a.org_id, a.status, a.error_message
        </text>
    </query>
    <query name="verified_count">
        <text>
            select org_id, count(distinct doc_id) as doc_count
            from summary_qafromseqfile
            where patient_key is not null
            group by org_id
        </text>
    </query>
    <query name="docs_queue">
        <text>
            select jr.org_id, jr.activity, count(distinct(dr.doc_id)) as doc_count, count(p.sent_to_persist) as sent_to_persist_count, count(p.sent_to_ocr) as sent_to_ocr_count
            from summary_coordinator_jobrequest jr
            left outer join summary_coordinator_jobfinish jf
            on jr.job_id=jf.job_id and jr.work_id=jf.work_id 
            left outer join summary_docreceiver_seqfile dr on dr.seqfile_file=jr.seqfile
            left outer join summary_parser p on p.job_id=jr.from_job_id and p.status='success'
            where jf.job_id is null and (jr.activity='parser' or jr.activity='ocr' or jr.activity='persist')
            group by jr.org_id, jr.activity
        </text>
    </query>
	
	<group name="completeness">
		<run-query name="archivedToS3_count"/>
		<run-query name="upload_count"/> 
		<run-query name="parse_count"/>
		<run-query name="ocr_count"/>
		<run-query name="persist_count"/>
		<run-query name="verified_count"/>
		<run-query name="jobs_queue"/>
	</group>
	
	<group name="upload">
	   <run-query name="upload_count"/>
	</group>
	
	<group name="documentsPending">
       <run-query name="docs_queue"/>
    </group>
	
</queries>